# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '97d86416-c350-48ee-8daa-7d7ac3bc7c2e'
  imageRepository: 'loeme'
  containerRegistry: 'latzo.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build and push
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

- stage: Deploy_Staging
  dependsOn: Build
  condition: succeeded()
  displayName: Deploy to Staging
  jobs:
    - deployment: Deploy
      environment: "Loeme-Staging"
      displayName: Deploy to Staging
      pool:
        vmimage: $(vmImageName)
      strategy:  
        runOnce:
          deploy:
            steps:
              - task: AzureWebAppContainer@1
                inputs:
                  azureSubscription: 'Latzo''s Azure Subscription (3e8973a3-39a6-4de2-a282-f1dcc07b8671)'
                  appName: 'python-weather-app'
                  deployToSlotOrASE: true
                  resourceGroupName: 'PythonWeatherApp'
                  slotName: 'staging'
                  containers: 'latzo.azurecr.io/loeme:$(tag)'
                  appSettings: '-DOCKER_REGISTRY_SERVER_URL https://latzo.azurecr.io -DOCKER_REGISTRY_SERVER_USERNAME latzo -DOCKER_REGISTRY_SERVER_PASSWORD $(DOCKER_REGISTRY_SERVER_PASSWORD)'

- stage: Deploy_Prod
  dependsOn: Deploy_Staging
  condition: succeeded()
  displayName: Deploy to Production
  jobs:
    - deployment: Deploy
      environment: "Loeme-Prod"
      displayName: Deploy to Production
      pool:
        vmImage: $(vmImageName)
      strategy:  
        runOnce:
          deploy:
            steps:
            - task: AzureWebAppContainer@1
              inputs:
                azureSubscription: 'Latzo''s Azure Subscription (3e8973a3-39a6-4de2-a282-f1dcc07b8671)'
                appName: 'python-weather-app'
                deployToSlotOrASE: true
                resourceGroupName: 'PythonWeatherApp'
                slotName: 'production'
                containers: 'latzo.azurecr.io/loeme:$(tag)'
                appSettings: '-DOCKER_REGISTRY_SERVER_URL https://latzo.azurecr.io -DOCKER_REGISTRY_SERVER_USERNAME latzo -DOCKER_REGISTRY_SERVER_PASSWORD $(DOCKER_REGISTRY_SERVER_PASSWORD)'
      